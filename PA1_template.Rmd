---
title: "Reproducible Research: Peer Assessment 1"
output: 
  html_document:
    keep_md: true
---


## Loading and preprocessing the data

The data set is already neatly formatted, the only processing we will do is convert the date column
into a proper `Date` object.

```{r echo=TRUE}
    if (!file.exists("activity.csv")) {
        unzip("activity.zip")
    }
    activity <- read.csv("activity.csv", colClasses = c("integer", "character", "integer"))
    activity$date <- as.Date(activity$date, "%Y-%m-%d")
```

## What is mean total number of steps taken per day?

#### Calculate the daily totals

Calculation of the daily sums is as simple as aggregating the steps by date. Also compute the median
and the average here.

```{r echo=TRUE}
    library(plyr)

    dailysteps <- aggregate(steps ~ date, data = activity, FUN = sum, na.action = na.omit)
    names(dailysteps) <- c("date", "total_steps")

    dailysteps.mean <- mean(dailysteps$total_steps)
    dailysteps.median <- median(dailysteps$total_steps)
```

#### Create a histogram plot of the totals

We'll use color to highlight concentration rather than overlay a density curve.

```{r echo=TRUE, fig.align='center'}
    library(ggplot2)

    ggplot(dailysteps, aes(x = total_steps)) + 
        geom_histogram(binwidth = 1000, aes(fill = ..count..), color = "black") + 
        scale_fill_gradient("count", low = "red", high = "steelblue") + 
        geom_rug() + 
        ggtitle("Total Steps by Day") + 
        xlab("Total Steps") + 
        ylab("Frequency") +
        geom_vline(xintercept = dailysteps.median, color = "green", linetype = "longdash") +
        geom_vline(xintercept = dailysteps.median, color = "orange", linetype = "dotted", size = 2)
```

- **Mean:** `r sprintf("%.0f", dailysteps.mean)`
- **Median:** `r sprintf("%.0f", dailysteps.median)`

## What is the average daily activity pattern?

First we need to know the average of each 5-minute period in the data set averaged across all days.

```{r echo=TRUE}
    ## for the moment at least continue ignoring NA values
    intervalsteps <- aggregate(steps ~ interval, data = activity, FUN = mean, na.action = na.omit)
    names(intervalsteps) <- c("interval", "mean_steps")

    # also calculate the max of all intervales
    intervalsteps.max <- intervalsteps[with(intervalsteps, mean_steps == max(mean_steps)), ]
```

Plot the mean steps x interval to see the average daily activity pattern for the set. Add in some
marker lines to show main points in the day.

```{r echo=TRUE, fig.align='center'}
    # odd factor creation is to ensure the ordering in the legend follows the clocktime order
    # and not the 'natural' ordering of the strings.
    times <- data.frame(clocktime = factor(c("1", "2", "3", "4", "5", "6"), 
                                           labels = c("6AM", "9AM", "12PM", "3PM", "6PM", "9PM")),
                        interval = c(600, 900, 1200, 1500, 1800, 2100))

    ggplot(intervalsteps, aes(x = interval, y = mean_steps)) + 
            geom_line() +
            ggtitle("Daily Activity Pattern") +
            xlab("Interval") +
            ylab("Average Steps (all days)") +
            geom_vline(data = times, 
                       aes(xintercept = interval, color = clocktime), 
                       show_guide = TRUE) +
            geom_point(data = intervalsteps.max, aes(x = interval, y = mean_steps), 
                       color = "red", shape = "X", size = 5)
```

- **Interval with max average steps**: `r sprintf("%s (%.1f)", intervalsteps.max$interval, intervalsteps.max$mean_steps)`

## Imputing missing values

#### NA Density

There can only be NA values in the `steps` column since the other columns are fixed identifiers and
not measurements.

```{r echo=TRUE}
    # Find all the missing values
    activity.nas <- activity[is.na(activity$steps),]
    natotal <- nrow(activity.nas)
```

- **Total number of NAs in the dataset:** `r natotal`

Is there any particular pattern to the NAs? More in a certain interval or more on certain days?

```{r echo=TRUE, message=FALSE}
    # for convenience convert each NA to '1'
    activity.nas$steps <- 1

    # NA's by interval
    ggplot() + geom_histogram(data = activity.nas, aes(x = interval), 
                              color = "black", fill = "steelblue") +
            coord_cartesian(ylim=c(0, 300)) +
            ggtitle("NA values by interval")

    # and by date
    ggplot() + geom_histogram(data = activity.nas, aes(x = date), 
                              color = "black", fill = "steelblue") +
            coord_cartesian(ylim=c(0, 300)) +
            ggtitle("NA values by date")

```


## Are there differences in activity patterns between weekdays and weekends?
